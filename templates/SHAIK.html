<body style="margin:0;padding:0;font-family:Arial, sans-serif;background:#111;color:#fff;">

    <!-- UPLOAD PANEL -->
    <div id="uploadPanel"
        style="
            width:100%;
            background:#1e1e1e;
            border-bottom:1px solid #333;
            padding:30px;
            position:fixed;
            top:-500px;
            left:0;
            z-index:50;
            transition:0.35s ease;
            min-height: 200px;
            box-sizing: border-box;
        "
    >
        <h2 style="margin-bottom:10px;color:#00e1ff;font-size:40px;">Upload Your Reel</h2>

        <form id="userreels" method="POST" 
              action="/userupload_reels" enctype="multipart/form-data"
              style="display:flex;flex-direction:column;gap:50px;">

            <input type="hidden" name="uploader" value="SHAIK">

            <input type="file" name="video" id="userFile" accept="video/*" required
                   style="
                        padding:12px;
                        background:#222;
                        color:#fff;
                        border-radius:10px;
                        border:1px solid #444;
                        font-size:40px;
                   ">

            <button type="submit"
                    style="
                        padding:12px;
                        background:#00e1ff;
                        border:none;
                        border-radius:10px;
                        color:#000;
                        font-size:30px;
                        font-weight:bold;
                        cursor:pointer;
                    ">
                Upload Reel
            </button>
        </form>

        <video id="userPreview"
               style="
                    display:none;
                    width:100%;
                    max-width:350px;
                    margin-top:12px;
                    border-radius:12px;
                    border:2px solid #00e1ff;
               "
               controls></video>
    </div>

    <!-- FLOATING UPLOAD BUTTON -->
    <button id="uploadBtn"
        style="
            position:fixed;
            bottom:40px;
            right:80px;
            width:100px;
            height:100px;
            border-radius:50%;
            background:#00e1ff;
            border:none;
            font-size:30px;
            font-weight:bold;
            color:#000;
            cursor:pointer;
            box-shadow:0 0 12px rgba(0,0,0,0.4);
            z-index:60;
        ">
        +
    </button>

    <!-- FULLSCREEN REELS SCROLL AREA -->
    <div id="reelsContainer"
         style="
            width:100%;
            height:100vh;
            overflow-y:scroll;
            scroll-snap-type:y mandatory;
            -webkit-overflow-scrolling:touch;
         ">
    </div>

<script>
// ------------------ REELS AUTOPLAY LOGIC ------------------
function applyAutoPlay() {
    const observer = new IntersectionObserver(entries => {
        entries.forEach(entry => {
            const video = entry.target.querySelector("video");
            if (!video) return;

            if (entry.isIntersecting) {
                video.play();
                video.muted = false;
                video.volume = 1.0;
            } else {
                video.pause();
            }
        });
    }, { threshold: 0.7 });

    document.querySelectorAll(".reel").forEach(reel => {
        observer.observe(reel);
    });
}

// ------------------ LOAD ALL REELS ------------------
// ------------------ LOAD ALL REELS (SHUFFLED) ------------------
async function loadReels() {
    const res = await fetch("/all_user_reels");
    const data = await res.json();

    if (!data.urls || data.urls.length === 0) return;

    const container = document.getElementById("reelsContainer");
    container.innerHTML = "";

    // ----------- SHUFFLE THE URLS ----------
    const shuffledUrls = data.urls.sort(() => Math.random() - 0.5);

    shuffledUrls.forEach((url, index) => {
        if (!url) return;

        const div = document.createElement("div");
        div.className = "reel";
        div.style = `
            height:100vh;
            width:100%;
            scroll-snap-align:start;
            display:flex;
            justify-content:center;
            align-items:center;
            background:#000;
            overflow:hidden;
            position:relative;
        `;

        div.innerHTML = `
    <video 
        src="${url}"
        style="width:100%;height:100%;object-fit:contain;"
        playsinline
        controls
        autoplay
    ></video>
    <div class="controls" style="
        position:absolute;
        top:50%;
        right:20px;
        transform:translateY(-50%);
        display:flex;
        flex-direction:column;
        gap:20px;
        z-index:5;
    ">
        <button class="playBtn" style="
            padding:14px 18px;
            font-size:18px;
            border-radius:8px;
            background:rgba(0,0,0,0.5);
            color:white;
            cursor:pointer;
        ">Pause</button>
        <button class="muteBtn" style="
            padding:14px 18px;
            font-size:18px;
            border-radius:8px;
            background:rgba(0,0,0,0.5);
            color:white;
            cursor:pointer;
        ">Unmute</button>
        <button class="downloadBtn" style="
            padding:14px 18px;
            font-size:18px;
            border-radius:8px;
            background:rgba(0,0,0,0.5);
            color:white;
            cursor:pointer;
        ">Download</button>
    </div>
`;


        container.appendChild(div);

        const videoEl = div.querySelector("video");
        const playBtn = div.querySelector(".playBtn");
        const muteBtn = div.querySelector(".muteBtn");
        const downloadBtn = div.querySelector(".downloadBtn");

        playBtn.addEventListener("click", e => {
            e.stopPropagation();
            if(videoEl.paused){ videoEl.play(); playBtn.innerText='Pause'; }
            else { videoEl.pause(); playBtn.innerText='Play'; }
        });

        muteBtn.addEventListener("click", e => {
            e.stopPropagation();
            videoEl.muted = !videoEl.muted;
            muteBtn.innerText = videoEl.muted ? 'Unmute' : 'Mute';
        });

        downloadBtn.addEventListener("click", e => {
            e.stopPropagation();
            const a = document.createElement('a');
            a.href = url;
            a.download = `video_${index+1}.mp4`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        });
    });

    applyAutoPlay();
}


loadReels();

// ------------------ SLIDE PANEL OPEN / CLOSE ------------------
const panel = document.getElementById("uploadPanel");
const btn = document.getElementById("uploadBtn");
let panelOpen = false;

btn.addEventListener("click", () => {
    if (!panelOpen) {
        panel.style.top = "0px";
        panelOpen = true;
    } else {
        panel.style.top = "-300px";
        panelOpen = false;
    }
});

// ------------------ PREVIEW ------------------
document.getElementById("userFile").addEventListener("change", e => {
    const file = e.target.files[0];
    const preview = document.getElementById("userPreview");

    if (file) {
        preview.src = URL.createObjectURL(file);
        preview.style.display = "block";
        preview.load();
    }
});

document.getElementById("userreels").addEventListener("submit", () => {
    setTimeout(() => {
        document.getElementById("userPreview").style.display = "none";
    }, 500);
});
</script>

</body>
